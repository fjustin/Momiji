!function(e){window.NestedFormEvents=function(){this.addFields=e.proxy(this.addFields,this),this.removeFields=e.proxy(this.removeFields,this)},NestedFormEvents.prototype={addFields:function(t){var r=t.currentTarget,d=e(r).data("association"),i=e("#"+e(r).data("blueprint-id")).data("blueprint"),n=(e(r).closest(".fields").closestChild("input, textarea, select").eq(0).attr("name")||"").replace(new RegExp("[[a-z_]+]$"),"");if(n)for(var s=n.match(/[a-z_]+_attributes(?=\]\[(new_)?\d+\])/g)||[],a=n.match(/[0-9]+/g)||[],l=0;l<s.length;l++)a[l]&&(i=(i=i.replace(new RegExp("(_"+s[l]+")_.+?_","g"),"$1_"+a[l]+"_")).replace(new RegExp("(\\["+s[l]+"\\])\\[.+?\\]","g"),"$1["+a[l]+"]"));var o=new RegExp("new_"+d,"g"),f=this.newId();i=e.trim(i.replace(o,f));var c=this.insertFields(i,d,r);return c.trigger({type:"nested:fieldAdded",field:c}).trigger({type:"nested:fieldAdded:"+d,field:c}),!1},newId:function(){return(new Date).getTime()},insertFields:function(t,r,d){var i=e(d).data("target");return i?e(t).appendTo(e(i)):e(t).insertBefore(d)},removeFields:function(t){var r=e(t.currentTarget),d=r.data("association");r.prev("input[type=hidden]").val("1");var i=r.closest(".fields");return i.hide(),i.trigger({type:"nested:fieldRemoved",field:i}).trigger({type:"nested:fieldRemoved:"+d,field:i}),!1}},window.nestedFormEvents=new NestedFormEvents,e(document).delegate("form a.add_nested_fields","click",nestedFormEvents.addFields).delegate("form a.remove_nested_fields","click",nestedFormEvents.removeFields)}(jQuery),function(e){e.fn.closestChild=function(t){if(t&&""!=t){var r=[];for(r.push(this);r.length>0;)for(var d=r.shift().children(),i=0;i<d.length;++i){var n=e(d[i]);if(n.is(t))return n;r.push(n)}}return e()}}(jQuery);